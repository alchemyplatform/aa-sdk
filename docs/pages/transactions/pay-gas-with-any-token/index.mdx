---
title: Pay gas with any token
description: Enable users to pay gas with tokens like USDC
slug: wallets/transactions/pay-gas-with-any-token
---

Gas fees paid in the native token can feel foreign to users that primarily hold stablecoins or your app's own token.
With Smart Wallets, you can allow users to pay for gas with any token, streamlining the user experience.

## How it works

When a user pays for gas with a token, the gas is fronted using the network's native gas token and the payment tokens are transferred from the user's wallet to a wallet you configure in the policy.
The equivalent USD amount and the admin fee are then added to the developer's monthly invoice.

Post-operation mode is recommended. This mode requires users to hold enough of the gas token in their wallet after their operation completes to pay the gas fee. If the balance is insufficient, the transaction reverts and you sponsor any gas used without token payment. If this doesn't work for your use case, see the [Token gas payment modes](#token-gas-payment-modes) section below for more options.

## Prerequisites

- API key from your [dashboard](https://dashboard.alchemy.com/apps)
- [A "pay gas with any token" policy](https://dashboard.alchemy.com/gas-manager/policy/create).

## Implementation

<Tabs>
  <Tab title="React">
    <Markdown src="react.mdx" />
  </Tab>
  <Tab title="JavaScript">
    <Markdown src="client.mdx" />
  </Tab>
  <Tab title="API">
    <Markdown src="api-postop.mdx" />
  </Tab>
</Tabs>

## Advanced

<Accordion title="Usage with prepare calls">

Pay gas with any token also works with the prepare calls methods in the various frameworks. Usage of the capability will be the same as when using send calls. It is recommended to use prepare calls if you want to inspect the prepared call prior to prompting the user for signature.

<Tabs>
  <Tab title="React">
    See the [`usePrepareCalls` react
    hook](/wallets/reference/account-kit/react/hooks/usePrepareCalls)
  </Tab>
  <Tab title="JavaScript">
    See the [`prepareCalls` SDK
    reference](/wallets/reference/account-kit/wallet-client/functions/prepareCalls)
  </Tab>
  <Tab title="API">
    See the [`wallet_prepareCalls` API
    reference](/wallets/api/smart-wallets/wallet-api-endpoints/wallet-api-endpoints/wallet-prepare-calls)
  </Tab>
</Tabs>

</Accordion>

<Accordion title="Token gas payment modes">
The configured mode determines when the user's token payment occurs.

**[Recommended] Post-Operation**

- No upfront allowance is required.
- The user signs an approval inside the same calls batch, and the paymaster pulls the token after the operation has executed.
- If that post-operation transfer fails, the entire batch is reverted and you (the developer) pay the gas fee.

**Pre-Operation:**

- The paymaster must have an allowance prior to the operation.
- This can be done either through a prior call to `approve()` or by using an [ERC-7597 Permit](https://eips.ethereum.org/EIPS/eip-7597) signature.
- If the required allowance isn't in place when the user operation is submitted, it will be rejected.

Post-operation mode is recommended for most use cases. This mode:

- Is the most gas efficient as it only requires a single transfer.
- Works with all ERC-20 tokens.
- Only ever requires a single signature from the user.

However, because tokens are deducted after execution, the developer may be required to pay for gas without receiving sufficient token payment.
The developer should ensure that users have enough token left over to pay for gas after the operation, otherwise they won't receive payment from users for gas and the operation will revert.
If the operation results in a static amount of the userâ€™s token balance after execution and the developer can account for this before submitting the operation, use PostOp mode.

Examples of static amounts:

- Payments, purchases, and deposits
- Operations unrelated to the payment token

Examples of dynamic amounts:

- Swaps that include the payment token

If you sponsor operations that result in dynamic amounts of the payment token left over, consider using pre-operation mode. See an example implementation below.

</Accordion>

<Accordion title="Pre-operation mode implementation">
  <Markdown src="api-preop.mdx" />
</Accordion>

<Accordion title="Estimating gas payments">
To show users the gas cost in their chosen gas token prior to signing and sending their request,
use the `prepareCalls` hook/action/api over the `sendCalls` version
as `sendCalls` doesn't surface the fee payment information during sign and send.

The return type of `prepareCalls` contains a `feePayment` field containing fee information. Display this information to users prior to signing the operation. For example:

```
  "feePayment": {
    "sponsored": false,
    "tokenAddress": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
    "maxAmount": "0x1d33"
  }
```

Calling `prepareCalls` using the token paymaster capability counts against your policy's pending total. If you intend on making many
calls to surface the best price, set the `onlyEstimation` parameter for estimation, and then remove only when the user intends to sign the result.

<Warning>
  Requests to `prepareCalls` count against your policy's pending total. Use
  `onlyEstimation` if the intention is to query for the fee and not to sign the
  operation. Note that `onlyEstimation` does not work with the `sendCalls`
  requests and must be used with `prepareCalls`.
</Warning>
</Accordion>

<Accordion title="Auto-injected approvals">
The Wallet APIs can be configured to automatically inject the required approvals into the operation when needed. The settings for this depend on the mode being used.

**Post-operation mode**

In post-operation mode, you can set the paymaster service capability to automatically inject approvals to the paymaster contract using the `erc20.postOp.autoApprove` field.
The approval will be batched with the provided calls to ensure it's in place before the transfer to the paymaster during post-operation.
To save gas, the approval is only injected if the sender's existing allowance on the paymaster contract is less than the `below` parameter. The injected approval will be set to
the `amount` parameter.

Set `below` high enough to reasonably cover the gas cost for your most expensive operations. Set `amount` to a value
you feel comfortable maintaining as an allowance on the paymaster contract. Setting a large `amount` is not recommended for security purposes.

**Pre-operation mode**

<Note>
  This is an advanced feature. Use post-operation mode for most use cases.
</Note>

In pre-operation mode, you can set the paymaster service capability to automatically return a request for a Permit signature using the `erc20.preOp.autoPermit` field.
This permit will allow an allowance to be set on the paymaster contract from the sender prior to any token transfers needed during pre operation.

To be eligible for auto-injected permits, the payment gas token must:

1. Be [ERC-7597](https://eips.ethereum.org/EIPS/eip-7597) compliant.
2. Expose a `version()` function.
3. Utilize the canonical `DOMAIN_SEPARATOR` outlined in [ERC-2612](https://eips.ethereum.org/EIPS/eip-2612).

If the user already has an allowance on the paymaster contract, the normal flow is used. If the user needs an
approval, the following steps inject the permit:

1. The prepare request returns a signature request for the paymaster permit.
2. The user signs the permit request and the signature request back in a second prepare request.
3. The permit signature is injected into the paymaster contract calldata, and a normal operation is returned.
4. The user proceeds as normal, signing and sending the operation.

</Accordion>

## Next steps

Build more:

- [Sponsor gas for users](/wallets/transactions/sponsor-gas)

Troubleshooting:

- [Gas manager errors](/docs/reference/gas-manager-errors)
