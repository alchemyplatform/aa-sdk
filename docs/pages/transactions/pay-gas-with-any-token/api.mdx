<Tabs>
<Tab title="Post-Op Mode">

<Steps>
  <Step title="(If Needed) Request Account">
    If the user does not yet have a smart account, you must create one.
```bash twoslash
  ACCOUNT_ADDRESS=$(curl --request POST \
  --url https://api.g.alchemy.com/v2/$ALCHEMY_API_KEY \
  --header 'accept: application/json' \
  --data '
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "wallet_requestAccount",
  "params": [
    { 
      "signerAddress": "'$SIGNER_ADDRESS'",
      "includeCounterfactualInfo": true 
    }
  ]
}
' | jq -r '.result.accountAddress')
```
  </Step>
  <Step title="Prepare Calls">
    Prepare calls using the `paymasterService` capability.
```bash twoslash
curl --request POST \
  --url https://api.g.alchemy.com/v2/$ALCHEMY_API_KEY \
  --header 'accept: application/json' \
  --data '
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "wallet_prepareCalls",
  "params": [
    {
      "capabilities": {
        "paymasterService": {
          "policyId": "'$ALCHEMY_POLICY_ID'",
          "erc20": {
            "tokenAddress": "'$GAS_TOKEN'",
            "postOpSettings": {
              "autoApprove": {
                "below": "'$APPROVE_BELOW'",
                "amount": "'$APPROVE_AMOUNT'"
              }
            }
          }
        }
      },
      "calls": [
        {
          "to": "0x0000000000000000000000000000000000000000"
        }
      ],
      "from": "'$ACCOUNT_ADDRESS'",
      "chainId": "'$CHAIN_ID'"
    }
  ]
}'
```
  </Step>
  <Step title="Sign & Send">
    Sign the returned signature request and send using `wallet_sendPreparedCalls`.
  </Step>
</Steps>

</Tab>
<Tab title="Pre-Op Mode">

<Steps>
  <Step title="(If Needed) Request Account">
    If the user does not yet have a smart account, you must create one.
```bash twoslash
  ACCOUNT_ADDRESS=$(curl --request POST \
  --url https://api.g.alchemy.com/v2/$ALCHEMY_API_KEY \
  --header 'accept: application/json' \
  --data '
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "wallet_requestAccount",
  "params": [
    { 
      "signerAddress": "'$SIGNER_ADDRESS'",
      "includeCounterfactualInfo": true 
    }
  ]
}
' | jq -r '.result.accountAddress')
```
  </Step>
  <Step title="Initial Prepare Calls">
    Prepare calls using the `paymasterService` capability.
```bash twoslash
curl --request POST \
  --url https://api.g.alchemy.com/v2/$ALCHEMY_API_KEY \
  --header 'accept: application/json' \
  --data '
{
  "id": 1,
  "jsonrpc": "2.0",
  "method": "wallet_prepareCalls",
  "params": [
    {
      "capabilities": {
        "paymasterService": {
          "policyId": "'$ALCHEMY_POLICY_ID'",
          "erc20": {
            "tokenAddress": "'$GAS_TOKEN'",
            "preOpSettings": {
              "autoPermit": {
                "below": "'$APPROVE_BELOW'",
                "amount": "'$APPROVE_AMOUNT'"
              }
            }
          }
        }
      },
      "calls": [
        {
          "to": "0x0000000000000000000000000000000000000000"
        }
      ],
      "from": "'$ACCOUNT_ADDRESS'",
      "chainId": "'$CHAIN_ID'"
    }
  ]
}'
```
  </Step>
  <Step title="(If Needed) Sign Permit Request">
    If the response to step 2 is a type `paymaster-permit`, then the user must sign the signature request and return via a second call to `wallet_prepareCalls`. Else, skip to step 5.
    The `data` field on the `paymaster-permit` response contains a [EIP-2612](https://eips.ethereum.org/EIPS/eip-2612) Permit typed message. It is recommended that the user
    checks the fields of this message prior to calculating its hash. The `signatureRequest` field on the `paymaster-permit` response is a required signature over the calculated
    hash. This is typically an ERC-712 typed signature envelope with a field for the hash to sign over.
  </Step>
  <Step title="(If Needed) Second Prepare Calls">
    After signing, another call to `wallet_prepareCalls` is needed to encode the permit into the operation. As a convenience, the `paymaster-permit` response type returns a `modifiedRequest`
    parameter that modifies the initial request with the permit details. The second request is the `modifiedRequest` with an additional `paymasterPermitSignature` field set to the
    signature from step 3. The user can also choose to recreate the request and set the corresponding fields in the `paymasterService` capability to the details returned in the permit signature.
    For example:
```
{
  "capabilities": {
    "paymasterService": {
      "erc20": {
        "preOp": {
          "permitDetails": {
            "value": "0x...",
            "deadline": "0x...",
          }
        }
      }
    }
  }
  ... // same request as step 2
  "paymasterPermitSignature": "0x..."
}
```
  </Step>
  <Step title="Sign & Send">
    Sign and send the last prepared calls result as usual using `wallet_sendPreparedCalls`.
  </Step>
</Steps>

</Tab>
</Tabs>
